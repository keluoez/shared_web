# P2P音乐共享系统需求文档 - Python后端版本

## 1. 项目概述

### 1.1 项目名称
P2P音乐共享系统

### 1.2 项目简介
本项目是一个基于WebRTC技术的点对点音乐共享平台，使用Python作为后端技术栈，允许用户直接共享和下载音乐文件，无需通过中心服务器中转文件内容。中心服务器仅用于维护节点信息和文件索引，不存储任何实际音乐文件。

### 1.3 设计目标
- 实现完全去中心化的文件传输机制
- 提供简单直观的用户界面
- 确保中心服务器轻量级运行
- 实时监控系统状态
- 无需用户注册，简化使用流程

## 2. 技术栈

### 2.1 后端技术
- **Web框架**: FastAPI (高性能，支持WebSocket，自动API文档)
- **WebSocket库**: 内置WebSocket支持
- **ASGI服务器**: Uvicorn
- **数据存储**: 内存存储 (Python字典结构)
- **哈希计算**: hashlib标准库

### 2.2 前端技术
- HTML/CSS/JavaScript
- WebRTC API
- WebSocket客户端

### 2.3 外部服务
- 公共STUN服务器 (stun.l.google.com:19302)
- 可选TURN服务器

## 3. 系统架构

### 3.1 架构图

```
+-----------------------------------------------------------------------+
|                          P2P音乐共享系统架构                           |
+-----------------------------------------------------------------------+
|                                                                       |
|  +----------------+      +---------------------+      +-------------+  |
|  |    节点1       |      |   Python后端服务器   |      |    节点2    |  |
|  | (浏览器客户端)  |      | (FastAPI + WebSocket) |    | (浏览器客户端)|  |
|  +----------------+      +---------------------+      +-------------+  |
|  | - 匿名节点ID   |      | - HTTP服务器        |      | - 匿名节点ID |  |
|  | - WebRTC连接   |      | - WebSocket服务器   |      | - WebRTC连接 |  |
|  | - 本地文件存储 |      | - 节点管理          |      | - 本地存储   |  |
|  | - 文件共享列表 |      | - 文件索引管理      |      |             |  |
|  +----------------+      +---------------------+      +-------------+  |
|          |                      |    HTTP/WebSocket    |               |
|          |      WebRTC信令       |       通信           |  WebRTC信令   |
|          +--------------------->| <------------------->| <------------+|
|          |                      |                      |               |
|          |                      |                      |               |
|          |    +-------------------------------------+  |               |
|          |    |            WebRTC直接连接            |  |               |
|          +----+-------------------------------------+--+               |
|               |         (实际文件传输通道)            |                |
|               +-------------------------------------+                 |
|                                                                       |
+-----------------------------------------------------------------------+
|                          外部服务依赖                                  |
|  +----------------+      +---------------------+                      |
|  |   STUN服务器   |      |    TURN服务器        |                      |
|  | (NAT穿透辅助)  |      | (中继备份)           |                      |
|  +----------------+      +---------------------+                      |
|                                                                       |
+-----------------------------------------------------------------------+
```

## 4. 功能需求

### 4.1 节点功能
- **文件共享**：用户可选择本地音乐文件进行共享
- **文件搜索**：用户可搜索其他节点共享的音乐文件
- **文件下载**：用户可从其他节点直接下载音乐文件
- **下载管理**：查看当前下载进度和已完成下载
- **自动匿名标识**：系统为每个会话生成唯一匿名ID标识节点

### 4.2 Python中心服务器功能
- **节点注册**：通过WebSocket记录连接节点的匿名ID和连接信息
- **文件索引**：使用内存字典维护所有共享文件的元数据
- **搜索服务**：响应节点的搜索请求，返回匹配的文件和对应节点信息
- **信令中转**：协助节点之间建立WebRTC连接
- **状态监控**：在终端实时显示连接节点和共享文件信息
- **心跳检测**：定期检查节点活跃状态，清理离线节点
- **优雅关闭**：服务器关闭时自动清空所有节点和文件信息

## 5. 运行流程

### 5.1 节点上线流程
1. 用户访问网站，加载前端界面
2. 前端自动生成匿名节点ID（使用UUID）
3. 前端通过WebSocket连接到Python后端服务器
4. 服务器记录节点连接信息到内存字典中

### 5.2 文件共享流程
1. 用户选择本地文件进行共享
2. 前端计算文件哈希值（SHA-256）作为唯一标识
3. 前端通过WebSocket向服务器发送文件元数据
4. 服务器更新内存中的文件索引字典

### 5.3 文件搜索流程
1. 用户输入搜索关键词
2. 前端通过WebSocket向服务器发送搜索请求
3. 服务器在内存文件索引中查找匹配项
4. 服务器返回匹配的文件列表及拥有这些文件的节点信息

### 5.4 文件下载流程
1. 用户选择要下载的文件
2. 前端从服务器获取拥有该文件的节点列表
3. 前端通过服务器交换WebRTC信令，与源节点建立连接
4. 通过WebRTC数据通道直接传输文件

### 5.5 Python服务器监控功能
- 实时终端输出显示连接节点信息
- 定期打印系统状态统计
- 记录所有关键操作日志
- 服务器关闭时自动清理所有数据

## 6. Python后端实现要点

### 6.1 数据模型
```python
# 使用Python字典和集合进行内存存储
nodes = {}  # node_id -> NodeInfo
files = {}  # file_hash -> FileInfo
node_files = {}  # node_id -> set(file_hashes)
```

### 6.2 核心功能
- **WebSocket连接管理**：处理节点连接和断开
- **心跳机制**：定期检查节点活跃状态
- **文件索引管理**：维护文件与节点的映射关系
- **信令转发**：协助节点间建立P2P连接

### 6.3 监控功能
- 实时显示连接节点数量和详细信息
- 显示共享文件统计和列表
- 记录所有节点操作和系统事件

## 7. 部署和运行

### 7.1 启动Python服务器
```bash
# 安装依赖
pip install fastapi uvicorn websockets

# 启动服务器
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 7.2 服务器终端监控
服务器终端将实时显示：
- 当前连接节点数
- 节点连接/断开信息
- 文件共享和搜索请求
- 系统资源使用情况

## 8. 优势特点

1. **高性能**: FastAPI提供异步支持，处理高并发连接
2. **简洁性**: Python代码简洁易维护
3. **实时性**: WebSocket提供实时通信能力
4. **轻量级**: 内存存储无需外部数据库
5. **易监控**: 丰富的终端输出和日志功能

这个Python版本的实现保持了原有需求的所有功能，同时利用了Python生态系统的优势，提供了简洁而高效的解决方案。